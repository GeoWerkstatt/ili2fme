! ----------------------------------------------------------------------
! INTERLIS 2 format metafile
! 
! Author               Date            Changes made
! ------------------   ------------    -------------------------------
! Claude Eisenhut      Nov 18, 2005    Original definition
! Dave Campanas        Dec 13, 2005    Added keyword definitions only
!                                      for UT - not used in workbench
! ----------------------------------------------------------------------

! ----------------------------------------------------------------------
! First define the format name.

SOURCE_READER ch.ehi.fme.Main 

IGNORE_ATTRIBUTES_WITH_PREFIX xtf_
!KEEP_ATTRIBUTE autocad_elevation

FORMAT_NAME ch.ehi.fme.Main

!------------------------------------------------------------------------
! If not using workbench, add the keyword definitions. Keyword 
! definitions are required for Java plug-ins, but are automatically 
! added by workbench using its own naming convention.

INCLUDE [if {"$(_WORKBENCH)" != "yes"} { \
     puts {SOURCE_KEYWORD ILI2_IN}; \
     puts {DESTINATION_KEYWORD ILI2_OUT}; \
            } ]

SOURCE_DATASET \"$[SourceDataset]\"
	    
! ----------------------------------------------------------------------
! Define the preamble for stuff that is only output when INTERLIS 2 is 
! the source format.

SOURCE_PREAMBLE

# ============================================================================ 
# The following GUI line prompts for a file to be used as the
# source of the input data.
# The user input is stored in a macro, which is then used to define
# the dataset to be read.

GUI FILENAME SourceDataset INTERLIS_2_Files(*.xtf)|*.xtf|All_Files|*.* Original INTERLIS 2 File:
__
GUI TEXT XTF_Models_In Models:
DEFAULT_MACRO XTF_Models_In "XTF"
"DEFAULT_MACRO" XTF_Models_In $(XTF_Models_In)
$(FMEGEN_SOURCE_KEYWORD)_MODELS \"$[XTF_Models_In]\"
__
GUI TEXT XTF_ModelDir_In Models directory:
DEFAULT_MACRO XTF_ModelDir_In "%XTF_DIR;$(FME_HOME)\plugins\interlis2\ilimodels;$(FME_HOME)\plugins\interlis2\ili22models"
"DEFAULT_MACRO" XTF_ModelDir_In $(XTF_ModelDir_In)
$(FMEGEN_SOURCE_KEYWORD)_MODEL_DIR \"$[XTF_ModelDir_In]\"
__
GUI TEXT XTF_CREATE_LINETABLES Create Linetables:
DEFAULT_MACRO XTF_CREATE_LINETABLES "False"
"DEFAULT_MACRO" XTF_CREATE_LINETABLES $(XTF_CREATE_LINETABLES)
$(FMEGEN_SOURCE_KEYWORD)_CREATE_LINETABLES \"$[XTF_CREATE_LINETABLES]\"
__
GUI TEXT XTF_SKIP_POLYGONBUILDING Skip polygon building:
DEFAULT_MACRO XTF_SKIP_POLYGONBUILDING "False"
"DEFAULT_MACRO" XTF_SKIP_POLYGONBUILDING $(XTF_SKIP_POLYGONBUILDING)
$(FMEGEN_SOURCE_KEYWORD)_SKIP_POLYGONBUILDING \"$[XTF_SKIP_POLYGONBUILDING]\"
__
GUI TEXT XTF_ILI1_ADDDEFVAL ITF Add default values:
DEFAULT_MACRO XTF_ILI1_ADDDEFVAL "False"
"DEFAULT_MACRO" XTF_ILI1_ADDDEFVAL $(XTF_ILI1_ADDDEFVAL)
$(FMEGEN_SOURCE_KEYWORD)_ILI1_ADDDEFVAL \"$[XTF_ILI1_ADDDEFVAL]\"
__
END_SOURCE_PREAMBLE

INCLUDE [if {$(FME_BUILD_NUM)>=4369} {\
     puts {SOURCE_SETTINGS}; \
     puts {GUI TITLE INTERLIS (ili2fme) Source Settings}; \
     puts {DEFAULT_VALUE MODELS "XTF"}; \
     puts {GUI TEXT MODELS Models:}; \
     puts {DEFAULT_VALUE MODEL_DIR "%XTF_DIR;$(FME_HOME)plugins/interlis2/ilimodels;$(FME_HOME)plugins/interlis2/ili22models"}; \
     puts {GUI TEXT MODEL_DIR Models directory:}; \
     puts {DEFAULT_VALUE CREATE_LINETABLES "No"}; \
     puts {GUI CHOICE CREATE_LINETABLES Yes%No Create Linetables:}; \
     puts {DEFAULT_VALUE SKIP_POLYGONBUILDING "No"}; \
     puts {GUI CHOICE SKIP_POLYGONBUILDING Yes%No Skip polygon building:}; \
     puts {DEFAULT_VALUE ILI1_ADDDEFVAL "No"}; \
     puts {GUI CHOICE ILI1_ADDDEFVAL Yes%No ITF Add default values:}; \
     puts {END_SOURCE_SETTINGS}; \
     } ]

DESTINATION_DATASET \"$[DestDataset]\"

! ----------------------------------------------------------------------
! Define the preamble for stuff that is only output when INTERLIS 2 is 
! the destination format.

DESTINATION_PREAMBLE

# ============================================================================ 
# The following GUI line prompts for a file to be used as the
# the destination for the INTERLIS 2 data.
GUI FILENAME DestDataset INTERLIS_2_Files(*.xtf)|*.xtf|All_Files|*.* Destination INTERLIS 2 File:
__
GUI TEXT XTF_Models_Out Models:
!DEFAULT_MACRO XTF_Models_Out "XTF"
!"DEFAULT_MACRO" XTF_Models_Out $(XTF_Models_Out)
$(FMEGEN_DESTINATION_KEYWORD)_MODELS \"$[XTF_Models_Out]\"
__
GUI TEXT XTF_ModelDir_Out Models directory:
DEFAULT_MACRO XTF_ModelDir_Out "%XTF_DIR;$(FME_HOME)\plugins\interlis2\ilimodels;$(FME_HOME)\plugins\interlis2\ili22models"
"DEFAULT_MACRO" XTF_ModelDir_Out $(XTF_ModelDir_Out)
$(FMEGEN_DESTINATION_KEYWORD)_MODEL_DIR \"$[XTF_ModelDir_Out]\"
__
END_DESTINATION_PREAMBLE

INCLUDE [if {$(FME_BUILD_NUM)>=4369} {\
     puts {DESTINATION_SETTINGS}; \
     puts {GUI TITLE INTERLIS (ili2fme) Destination Settings}; \
     puts {GUI TEXT MODELS Models:}; \
     puts {DEFAULT_VALUE MODEL_DIR "%XTF_DIR;$(FME_HOME)plugins/interlis2/ilimodels;$(FME_HOME)plugins/interlis2/ili22models"}; \
     puts {GUI TEXT MODEL_DIR Models directory:}; \
     puts {END_DESTINATION_SETTINGS}; \
     } ]


PREAMBLE

END_PREAMBLE

WORKBENCH_EXPOSABLE_ATTRIBUTES \
    xtf_class    char(20) \
    xtf_basket    char(20) \
    xtf_geomattr char(20) 
			

ATTRIBUTE_CASE ANY

! Setting of ATTRIBUTE_LENGTH is required by FME. 
! Otherwise appear strange attribute names in output schema
ATTRIBUTE_LENGTH 255

!ATTRIBUTE_INVALID_CHARS ":. %-#[]\"()!?*'&+\/{}"
!DEST_ILLEGAL_ATTR_LIST         \
!    "_"                        \
!    INTERLIS                   

DEF_LINE_TEMPLATE {FME_GEN_GROUP_NAME} 
CORR_LINE_TEMPLATE {FME_GEN_GROUP_NAME} 
DEF_LINE_BREAK ATTRIB_CHANGE

GEOM_MAP xtf_none         fme_no_geom
GEOM_MAP xtf_coord        fme_point
GEOM_MAP xtf_coord        fme_text
GEOM_MAP xtf_polyline     fme_line
GEOM_MAP xtf_surface      fme_polygon
GEOM_MAP xtf_area         fme_polygon

!for fme_arc we will stroke it AND store it in a polyline
GEOM_MAP xtf_polyline         fme_arc              \
         XTF_PAX              fme_primary_axis     \
         XTF_SAX              fme_secondary_axis   \
         XTF_ROT              fme_rotation         \
         XTF_STAN             fme_start_angle      \
         XTF_SWAN             fme_sweep_angle      \
         @Arc(&XTF_PAX,&XTF_SAX,0,&XTF_ROT, &XTF_STAN, &XTF_SWAN)
         
!for fme_ellipse we will stroke it AND store in an area
GEOM_MAP xtf_area             fme_ellipse          \
         XTF_PAX              fme_primary_axis     \
         XTF_SAX              fme_secondary_axis   \
         XTF_ROT              fme_rotation         \
         @Arc(&XTF_PAX,&XTF_SAX,0,&XTF_ROT)
         
!for fme_rectangle AND fme_rounded_rectangle we will store it in an area
GEOM_MAP xtf_area fme_rectangle
GEOM_MAP xtf_area fme_rounded_rectangle 

ATTR_TYPE_MAP  xtf_char(width)             fme_char(width)            \
               xtf_number(width,decimal)   fme_decimal(width,decimal) 

GENERICIZE_GEOMTYPE_ATTR_NAME xtf_geomtype

